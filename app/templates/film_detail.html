{% extends 'base.html' %}
{% block title %}{{ film.title }} - Jadwal{% endblock %}
{% block content %}

{% set poster_src =
  film.poster if film.poster and (film.poster.startswith('http://') or film.poster.startswith('https://'))
  else url_for('static', filename='img/' ~ (film.poster or 'placeholder.jpg'))
%}

<div class="row g-4">
  <div class="col-md-4">
    <div class="card card-film">
      <img src="{{ poster_src }}"
           class="img-fluid"
           style="width:100%; height:520px; object-fit:cover;"
           alt="{{ film.title }}">
    </div>
  </div>

  <div class="col-md-8">
    <div class="d-flex flex-column gap-2">
      <h1 class="mb-0 fw-bold">{{ film.title }}</h1>

      <div class="text-muted">
        {% if film.duration %}{{ film.duration }} min{% endif %}
        {% if film.genre %} â€¢ {{ film.genre }}{% endif %}
      </div>

      {% if film.description %}
        <p class="mt-2" style="max-width: 70ch;">{{ film.description }}</p>
      {% endif %}
    </div>

    <hr class="my-4" style="border-color: rgba(255,255,255,.12);">

    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <h4 class="mb-0">Jadwal Tayang</h4>
      <div class="text-muted small">Klik jam untuk pilih kursi</div>
    </div>

    {% if schedules %}
      {# group jadwal per tanggal #}
      {% set ns = namespace(groups={}) %}
      {% for s in schedules %}
        {% set d = s.show_time.strftime('%Y-%m-%d') %}
        {% if d not in ns.groups %}
          {% set _ = ns.groups.update({d: []}) %}
        {% endif %}
        {% set _ = ns.groups[d].append(s) %}
      {% endfor %}

      <div class="mt-3 d-grid gap-3">
        {% for d, items in ns.groups.items() %}
          <div class="p-3 rounded-4"
               style="background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.10);">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
              <div class="fw-bold">
                {{ items[0].show_time.strftime('%d %b %Y') }}
              </div>
              <div class="text-muted small">
                Rp{{ "{:,}".format(items[0].price).replace(",", ".") }}
              </div>
            </div>

            <div class="d-flex flex-wrap gap-2">
              {% for s in items %}
                <a class="btn btn-accent btn-sm"
                   href="{{ url_for('public.choose_seat', schedule_id=s.id) }}">
                  {{ s.show_time.strftime('%H:%M') }}
                </a>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>

    {% else %}
      <p class="text-muted mt-3">Belum ada jadwal untuk film ini.</p>
    {% endif %}
  </div>
</div>

{% endblock %}
