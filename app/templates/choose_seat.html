{% extends "base.html" %}
{% block title %}Pilih Kursi{% endblock %}
{% block content %}

<script type="application/json" id="seat-data">
{
  "booked": {{ booked_seats | tojson }},
  "preselected": {{ preselected_seats | tojson }},
  "price": {{ schedule.price or 0 }},
  "filmTitle": {{ film.title | tojson }},
  "showTime": {{ schedule.show_time.strftime('%d %b %Y %H:%M') | tojson }}
}
</script>

<div class="row g-4">
  <!-- LEFT: Seat Map -->
  <div class="col-lg-8">
    <div class="seat-card p-3 p-md-4 rounded-4">
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
        <div>
          <h3 class="mb-1">Pilih Kursi</h3>
          <div class="text-muted">
            <span class="me-2">{{ film.title }}</span>
            <span class="opacity-75">â€¢</span>
            <span class="ms-2">{{ schedule.show_time.strftime('%d %b %Y %H:%M') }}</span>
          </div>
        </div>

        <div class="seat-legend d-flex gap-3 flex-wrap">
          <div class="d-flex align-items-center gap-2">
            <span class="seat-dot available"></span><span class="text-muted">Available</span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="seat-dot selected"></span><span class="text-muted">Selected</span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="seat-dot reserved"></span><span class="text-muted">Booked</span>
          </div>
        </div>
      </div>

      <div class="screen mb-3">SCREEN</div>

      <div class="seat-grid-wrap">
        <div id="seat-grid" class="seat-grid"></div>
      </div>

      <div class="text-muted small mt-3">
        Tip: klik kursi untuk memilih. Kursi yang sudah dibooking tidak bisa dipilih.
      </div>
    </div>
  </div>

  <!-- RIGHT: Summary -->
  <div class="col-lg-4">
    <div class="seat-card p-3 p-md-4 rounded-4 seat-sticky">
      <h5 class="mb-3">Ringkasan</h5>

      <div class="d-flex justify-content-between">
        <div class="text-muted">Film</div>
        <div id="sum-film" class="fw-semibold text-end"></div>
      </div>
      <div class="d-flex justify-content-between mt-2">
        <div class="text-muted">Jadwal</div>
        <div id="sum-time" class="fw-semibold text-end"></div>
      </div>

      <hr style="border-color: rgba(255,255,255,.12);">

      <div class="d-flex justify-content-between">
        <div class="text-muted">Kursi</div>
        <div id="sum-seats" class="fw-semibold text-end">-</div>
      </div>
      <div class="d-flex justify-content-between mt-2">
        <div class="text-muted">Jumlah</div>
        <div id="sum-count" class="fw-semibold">0</div>
      </div>
      <div class="d-flex justify-content-between mt-2">
        <div class="text-muted">Harga</div>
        <div id="sum-price" class="fw-semibold">Rp0</div>
      </div>

      <form method="POST" class="mt-3">
        <input type="hidden" name="seats" id="seats-input" value="">
        <button type="submit" id="btn-continue" class="btn btn-accent w-100" disabled>
          Lanjut Checkout
        </button>
      </form>

      {% if repeat_id %}
        <div class="text-muted small mt-2">
          Repeat order aktif (prefill dari booking #{{ repeat_id }})
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const data = JSON.parse(document.getElementById("seat-data").textContent);

  const booked = new Set(data.booked || []);
  const preselected = new Set(data.preselected || []);
  const price = Number(data.price || 0);

  const rows = ["A","B","C","D","E","F"];
  const cols = [1,2,3,4,5,6,7,8];

  const selected = new Set();

  const grid = document.getElementById("seat-grid");
  const seatsInput = document.getElementById("seats-input");
  const btnContinue = document.getElementById("btn-continue");

  const sumFilm = document.getElementById("sum-film");
  const sumTime = document.getElementById("sum-time");
  const sumSeats = document.getElementById("sum-seats");
  const sumCount = document.getElementById("sum-count");
  const sumPrice = document.getElementById("sum-price");

  sumFilm.textContent = data.filmTitle || "";
  sumTime.textContent = data.showTime || "";

  function rupiah(n){
    return "Rp" + (n||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  function updateSummary(){
    const arr = Array.from(selected).sort();
    seatsInput.value = arr.join(",");
    sumSeats.textContent = arr.length ? arr.join(", ") : "-";
    sumCount.textContent = String(arr.length);
    sumPrice.textContent = rupiah(arr.length * price);
    btnContinue.disabled = arr.length === 0;
  }

  function seatEl(label, state){
    const el = document.createElement("button");
    el.type = "button";
    el.className = `seat ${state}`;
    el.textContent = label;
    el.setAttribute("aria-label", `Seat ${label}`);
    if (state === "reserved") el.disabled = true;
    return el;
  }

  function render(){
    grid.innerHTML = "";

    // header row (numbers)
    const header = document.createElement("div");
    header.className = "seat-row header";
    header.appendChild(document.createElement("div")); // empty corner
    for (const c of cols){
      const h = document.createElement("div");
      h.className = "seat-h";
      h.textContent = c;
      header.appendChild(h);
    }
    grid.appendChild(header);

    for (const r of rows){
      const row = document.createElement("div");
      row.className = "seat-row";

      const rLabel = document.createElement("div");
      rLabel.className = "seat-r";
      rLabel.textContent = r;
      row.appendChild(rLabel);

      for (const c of cols){
        const seat = `${r}${c}`;

        let state = "available";
        if (booked.has(seat)) state = "reserved";
        else if (selected.has(seat)) state = "selected";

        const el = seatEl(seat, state);

        el.addEventListener("click", () => {
          if (booked.has(seat)) return;
          if (selected.has(seat)) selected.delete(seat);
          else selected.add(seat);
          updateSummary();
          render();
        });

        row.appendChild(el);
      }

      grid.appendChild(row);
    }
  }

  // Prefill repeat (skip kalau sudah booked)
  for (const s of preselected){
    if (!booked.has(s)) selected.add(s);
  }

  updateSummary();
  render();
});
</script>

{% endblock %}
